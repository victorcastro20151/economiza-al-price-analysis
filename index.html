<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economiza Alagoas - Análise de Preços</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 960px;
        }
        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-10 transition-all duration-300">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Economiza Alagoas</h1>
            <p class="text-center text-gray-500 mb-6">Encontre o melhor preço dos produtos no estado.</p>
            
            <!-- Formulário de Busca -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="product-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar Produto</label>
                    <input type="text" id="product-search" placeholder="Ex: arroz, feijão, pimenta biquinho"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
                <div>
                    <label for="city-select" class="block text-sm font-medium text-gray-700 mb-1">Município</label>
                    <select id="city-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        <option value="2704302">Maceió</option>
                        <option value="2700300">Arapiraca</option>
                    </select>
                </div>
                <button id="search-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 transform hover:scale-105">
                    Buscar Preços
                </button>
            </div>

            <!-- Loader (escondido por padrão) -->
            <div id="loader" class="hidden flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            </div>

            <!-- Div para resultados e estatísticas -->
            <div id="results" class="hidden mt-8 transition-all duration-300">
                <!-- Estatísticas -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Resumo dos Preços</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200 text-center">
                            <p class="text-xs text-gray-500">Média Interna</p>
                            <p id="trimmed-mean" class="text-xl font-bold text-blue-600">--</p>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200 text-center">
                            <p class="text-xs text-gray-500">Mediana</p>
                            <p id="median" class="text-xl font-bold text-green-600">--</p>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200 text-center">
                            <p class="text-xs text-gray-500">Moda</p>
                            <p id="mode" class="text-xl font-bold text-purple-600">--</p>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Resultados -->
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-2 md:mb-0">Resultados da Pesquisa</h2>
                        <button id="download-button" class="w-full md:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                            Baixar Dados (CSV)
                        </button>
                    </div>
                    <input type="text" id="company-filter" placeholder="Filtrar por nome da empresa..."
                           class="w-full mb-4 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    <div class="overflow-x-auto scrollbar-hide">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <tr>
                                    <th class="py-3 px-6 text-left">Empresa</th>
                                    <th class="py-3 px-6 text-left">Preço (R$)</th>
                                    <th class="py-3 px-6 text-left">Data da Venda</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Resultados serão injetados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Div para mensagens de erro -->
            <div id="message-box" class="hidden mt-8 text-center text-gray-600 p-4 rounded-lg border border-gray-300">
                <p id="message-text">Nenhum resultado encontrado.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // URL do proxy
            const PROXY_URL = 'https://corsproxy.io/?';
            const BASE_URL = PROXY_URL + encodeURIComponent("http://api.sefaz.al.gov.br/sfz-economiza-alagoas-api/api/public/");
            const APP_TOKEN = "3d0979f6358f21a20840530109466f451e2d51b5";
            const headers = {
                "Content-Type": "application/json",
                "AppToken": APP_TOKEN
            };

            const searchButton = document.getElementById('search-button');
            const downloadButton = document.getElementById('download-button');
            const productSearchInput = document.getElementById('product-search');
            const citySelect = document.getElementById('city-select');
            const resultsDiv = document.getElementById('results');
            const loaderDiv = document.getElementById('loader');
            const trimmedMeanElem = document.getElementById('trimmed-mean');
            const medianElem = document.getElementById('median');
            const modeElem = document.getElementById('mode');
            const resultsTableBody = document.getElementById('results-table-body');
            const companyFilterInput = document.getElementById('company-filter');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            let allResults = [];

            const calculateStatistics = (prices) => {
                if (prices.length === 0) {
                    return { trimmedMean: '--', median: '--', mode: '--' };
                }
                
                // Média Interna (trimmed mean)
                prices.sort((a, b) => a - b);
                const trimSize = Math.floor(prices.length * 0.05);
                const trimmedPrices = prices.slice(trimSize, prices.length - trimSize);
                const trimmedMean = trimmedPrices.reduce((sum, current) => sum + current, 0) / trimmedPrices.length;

                // Mediana
                const mid = Math.floor(prices.length / 2);
                const median = prices.length % 2 !== 0 ? prices[mid] : (prices[mid - 1] + prices[mid]) / 2;

                // Moda
                const counts = {};
                prices.forEach(price => {
                    counts[price] = (counts[price] || 0) + 1;
                });
                let modeValue = null;
                let maxCount = 0;
                for (const price in counts) {
                    if (counts[price] > maxCount) {
                        maxCount = counts[price];
                        modeValue = parseFloat(price);
                    } else if (counts[price] === maxCount) {
                        modeValue = null;
                    }
                }
                
                return { trimmedMean, median, mode: modeValue };
            };

            const renderResults = (data) => {
                resultsTableBody.innerHTML = '';
                if (!data || data.length === 0) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Nenhum resultado encontrado para este produto.';
                    resultsDiv.classList.add('hidden');
                    return;
                }

                messageBox.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
                
                const prices = data.map(item => item.produto.venda.valorVenda);
                const stats = calculateStatistics(prices);
                trimmedMeanElem.textContent = `R$ ${stats.trimmedMean.toFixed(2)}`;
                medianElem.textContent = `R$ ${stats.median.toFixed(2)}`;
                modeElem.textContent = stats.mode ? `R$ ${stats.mode.toFixed(2)}` : 'N/A';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                    const nomeFantasia = item.estabelecimento.nomeFantasia || 'Não informado';
                    const valorVenda = item.produto.venda.valorVenda.toFixed(2);
                    const dataVenda = new Date(item.produto.venda.dataVenda).toLocaleDateString('pt-BR');

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${nomeFantasia}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap font-bold text-green-600">R$ ${valorVenda}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${dataVenda}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
            };

            const fetchData = async () => {
                const product = productSearchInput.value.trim();
                const cityIBGE = citySelect.value;
                if (!product) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Por favor, digite o nome de um produto para pesquisar.';
                    resultsDiv.classList.add('hidden');
                    return;
                }

                loaderDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                messageBox.classList.add('hidden');

                const payload = {
                    "produto": {"descricao": product},
                    "estabelecimento": {"municipio": {"codigoIBGE": cityIBGE}},
                    "dias": 5,
                    "pagina": 1,
                    "registrosPorPagina": 500
                };
                
                const requestUrl = BASE_URL + encodeURIComponent("produto/pesquisa");

                try {
                    const response = await fetch(requestUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    if (response.status === 200) {
                        allResults = data.conteudo;
                        renderResults(allResults);
                    } else {
                        allResults = [];
                        messageBox.classList.remove('hidden');
                        messageText.textContent = `Erro: ${data.mensagem || 'Ocorreu um erro na requisição.'}`;
                        resultsDiv.classList.add('hidden');
                    }
                } catch (error) {
                    allResults = [];
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Não foi possível conectar à API. Verifique sua conexão ou tente novamente mais tarde.';
                    resultsDiv.classList.add('hidden');
                } finally {
                    loaderDiv.classList.add('hidden');
                }
            };
            
            const downloadCsv = () => {
                if (allResults.length === 0) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Não há dados para baixar. Faça uma pesquisa primeiro.';
                    return;
                }

                const headers = ["descricao", "valorVenda", "dataVenda", "nomeFantasia", "razaoSocial", "cnpj", "municipio", "bairro"];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n";
                
                allResults.forEach(item => {
                    const produto = item.produto;
                    const estabelecimento = item.estabelecimento;
                    const venda = produto.venda;

                    const row = [
                        produto.descricao,
                        venda.valorVenda,
                        new Date(venda.dataVenda).toLocaleDateString('pt-BR'),
                        estabelecimento.nomeFantasia,
                        estabelecimento.razaoSocial,
                        estabelecimento.cnpj,
                        estabelecimento.endereco.municipio,
                        estabelecimento.endereco.bairro
                    ].map(value => `"${String(value).replace(/"/g, '""')}"`).join(";");

                    csvContent += row + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "analise_precos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            searchButton.addEventListener('click', fetchData);
            downloadButton.addEventListener('click', downloadCsv);
            
            companyFilterInput.addEventListener('input', (e) => {
                const filterText = e.target.value.toLowerCase();
                const rows = resultsTableBody.getElementsByTagName('tr');
                Array.from(rows).forEach(row => {
                    const companyName = row.cells[0].textContent.toLowerCase();
                    if (companyName.includes(filterText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
