const functions = require('firebase-functions');
const fetch = require('node-fetch');

const BASE_URL = "http://api.sefaz.al.gov.br/sfz-economiza-alagoas-api/api/public/";
const APP_TOKEN = "3d0979f6358f21a20840530109466f451e2d51b5";

exports.proxyApi = functions.https.onRequest(async (request, response) => {
    // Definindo CORS para permitir requisições do seu frontend
    response.set('Access-Control-Allow-Origin', '*');
    response.set('Access-Control-Allow-Headers', 'Content-Type');

    if (request.method === 'OPTIONS') {
        response.status(204).send('');
        return;
    }

    if (request.method !== 'POST') {
        response.status(405).send('Método não permitido');
        return;
    }

    try {
        const payload = request.body;
        const apiResponse = await fetch(BASE_URL + "produto/pesquisa", {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                "AppToken": APP_TOKEN
            },
            body: JSON.stringify(payload)
        });

        if (!apiResponse.ok) {
            console.error(`Erro da API: ${apiResponse.status} ${apiResponse.statusText}`);
            response.status(apiResponse.status).send('Erro na comunicação com a API de preços.');
            return;
        }

        const data = await apiResponse.json();
        response.status(200).json(data);
    } catch (error) {
        console.error('Erro ao processar a requisição:', error);
        response.status(500).send('Erro interno do servidor.');
    }
});
