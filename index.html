<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Preços</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Economiza Alagoas - Pesquisa de Preços</h1>
        <div class="mb-4">
            <label for="search-term" class="block text-gray-700 font-semibold mb-2">Digite o produto:</label>
            <div class="flex rounded-lg shadow-sm">
                <input type="text" id="search-term" class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Arroz Tio João 5kg">
                <button id="search-button" class="bg-blue-600 text-white p-3 rounded-r-lg hover:bg-blue-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Nova caixa de seleção para município -->
        <div class="mb-4">
            <label for="city-select" class="block text-gray-700 font-semibold mb-2">Selecione o Município:</label>
            <select id="city-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>

        <div id="status-message" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>

        <div id="results-container" class="mt-6 space-y-4" style="display: none;">
            <div id="summary-card" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                <h2 class="font-bold text-blue-800 mb-2">Resumo da Pesquisa</h2>
                <p id="total-results" class="text-sm text-blue-700"></p>
                <p id="average-price" class="text-lg font-semibold text-blue-900 mt-1"></p>
                <p id="mode-price" class="text-sm text-blue-700 mt-1"></p>
                <p id="median-price" class="text-sm text-blue-700 mt-1"></p>
            </div>

            <div id="stores-list-card" class="bg-gray-50 border-l-4 border-gray-500 p-4 rounded-lg">
                <h2 class="font-bold text-gray-800 mb-2">Preços por Estabelecimento</h2>
                <ul id="stores-list" class="space-y-2"></ul>
            </div>
        </div>

        <!-- Link para o site oficial -->
        <div class="text-center mt-6">
            <a href="https://economizaalagoas.sefaz.al.gov.br" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm font-semibold transition-colors duration-200">
                Acessar site oficial Economiza Alagoas
            </a>
        </div>
    </div>

    <script>
        // URL da sua Cloud Function implantada no Firebase
        const API_URL = "https://us-central1-dev-zephyr-468119-k0.cloudfunctions.net/proxy_api";

        // Cidades e seus códigos IBGE para a caixa de seleção
        const cities = [
            { name: 'Maceió', ibge: 2704302 },
            { name: 'Arapiraca', ibge: 2700300 },
            { name: 'Palmeira dos Índios', ibge: 2706307 },
            { name: 'Rio Largo', ibge: 2707602 }
        ];

        // Popula a caixa de seleção de municípios
        const citySelect = document.getElementById('city-select');
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.ibge;
            option.textContent = city.name;
            citySelect.appendChild(option);
        });

        document.getElementById('search-button').addEventListener('click', fetchData);
        document.getElementById('search-term').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchData();
            }
        });

        async function fetchData() {
            const searchTerm = document.getElementById('search-term').value.trim();
            const selectedCityIBGE = document.getElementById('city-select').value;

            if (!searchTerm) {
                showMessage("Por favor, digite um produto para pesquisar.", "bg-red-100 text-red-700");
                return;
            }

            showMessage("Pesquisando... isso pode levar alguns segundos.", "bg-yellow-100 text-yellow-700");
            hideResults();

            const payload = {
                "endpoint": "produto/pesquisa",
                "produto": {"descricao": searchTerm},
                "estabelecimento": {"municipio": {"codigoIBGE": parseInt(selectedCityIBGE)}},
                "dias": 5,
                "pagina": 1,
                "registrosPorPagina": 500
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na rede: ${response.status} ${errorText}`);
                }

                const data = await response.json();
                
                if (data.conteudo && data.conteudo.length > 0) {
                    displayResults(data.conteudo);
                    showMessage(`✅ Sucesso! Total de registros: ${data.totalRegistros}`, "bg-green-100 text-green-700");
                } else {
                    showMessage("Nenhum resultado encontrado para este produto.", "bg-orange-100 text-orange-700");
                    hideResults();
                }

            } catch (error) {
                console.error('Erro:', error);
                showMessage(`❌ Ocorreu um erro: ${error.message}. Por favor, verifique a conexão e tente novamente.`, "bg-red-100 text-red-700");
                hideResults();
            }
        }

        function displayResults(data) {
            const prices = data.map(item => item.produto.venda.valorVenda);
            
            // Cálculos estatísticos
            const averagePrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
            const modePrice = getMode(prices);
            const medianPrice = getMedian(prices);

            // Atualizar o card de resumo
            document.getElementById('total-results').textContent = `Total de registros: ${data.length}`;
            document.getElementById('average-price').textContent = `Preço Médio: R$ ${averagePrice.toFixed(2)}`;
            document.getElementById('mode-price').textContent = `Preço mais comum: R$ ${modePrice ? modePrice.toFixed(2) : 'Não há'}`;
            document.getElementById('median-price').textContent = `Mediana: R$ ${medianPrice.toFixed(2)}`;

            // Listar os preços por estabelecimento
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = ''; // Limpar a lista antiga
            
            // Agrupar por estabelecimento
            const storesData = {};
            data.forEach(item => {
                const nomeFantasia = item.estabelecimento.nomeFantasia || 'Estabelecimento não informado';
                const valorVenda = item.produto.venda.valorVenda;
                const dataVenda = item.produto.venda.dataVenda ? new Date(item.produto.venda.dataVenda).toLocaleDateString() : 'N/A';
                
                if (!storesData[nomeFantasia]) {
                    storesData[nomeFantasia] = {
                        prices: [],
                        data: dataVenda
                    };
                }
                storesData[nomeFantasia].prices.push(valorVenda);
            });

            for (const store in storesData) {
                const prices = storesData[store].prices;
                const minPrice = Math.min(...prices);
                const li = document.createElement('li');
                li.className = 'border-b last:border-b-0 py-2 flex justify-between items-center';
                li.innerHTML = `
                    <span class="font-semibold text-gray-700">${store}</span>
                    <span class="font-bold text-lg text-green-600">R$ ${minPrice.toFixed(2)}</span>
                `;
                storesList.appendChild(li);
            }
            
            document.getElementById('results-container').style.display = 'block';
        }

        function showMessage(message, colorClass) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `mt-4 p-3 rounded-lg text-center ${colorClass}`;
            statusDiv.style.display = 'block';
        }

        function hideResults() {
            document.getElementById('results-container').style.display = 'none';
        }

        // Funções auxiliares para cálculos estatísticos
        function getMode(arr) {
            const counts = {};
            arr.forEach(num => counts[num] = (counts[num] || 0) + 1);
            let mode = null;
            let maxCount = 0;
            for (const num in counts) {
                if (counts[num] > maxCount) {
                    maxCount = counts[num];
                    mode = parseFloat(num);
                }
            }
            // Verifica se há um único modo, se não, retorna null
            const modes = Object.keys(counts).filter(key => counts[key] === maxCount);
            return modes.length === 1 ? parseFloat(modes[0]) : null;
        }

        function getMedian(arr) {
            const sortedArr = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sortedArr.length / 2);
            return sortedArr.length % 2 !== 0 ? sortedArr[mid] : (sortedArr[mid - 1] + sortedArr[mid]) / 2;
        }
    </script>
</body>
</html>
