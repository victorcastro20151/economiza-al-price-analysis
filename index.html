<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economiza Alagoas - Análise de Preços</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 960px;
        }
        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-10 transition-all duration-300">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Economiza Alagoas - Análise de Preços</h1>
            <p class="text-center text-gray-500 mb-6">Encontre o melhor preço dos produtos no estado.</p>
            
            <!-- Formulário de Busca -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="product-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar Produto</label>
                    <input type="text" id="product-search" placeholder="Ex: arroz, feijão, pimenta biquinho"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
                <div>
                    <label for="city-select" class="block text-sm font-medium text-gray-700 mb-1">Município</label>
                    <select id="city-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        <option value="2700102">Água Branca</option>
                        <option value="2700201">Anadia</option>
                        <option value="2700300">Arapiraca</option>
                        <option value="2700409">Atalaia</option>
                        <option value="2700508">Barra de Santo Antônio</option>
                        <option value="2700607">Barra de São Miguel</option>
                        <option value="2700706">Batalha</option>
                        <option value="2700805">Belém</option>
                        <option value="2700904">Belo Monte</option>
                        <option value="2701001">Boca da Mata</option>
                        <option value="2701100">Branquinha</option>
                        <option value="2701209">Cacimbinhas</option>
                        <option value="2701308">Cajueiro</option>
                        <option value="2701357">Campestre</option>
                        <option value="2701407">Campo Alegre</option>
                        <option value="2701506">Campo Grande</option>
                        <option value="2701605">Canapi</option>
                        <option value="2701704">Capela</option>
                        <option value="2701803">Carneiros</option>
                        <option value="2701902">Chã Preta</option>
                        <option value="2702009">Coité do Nóia</option>
                        <option value="2702108">Colônia Leopoldina</option>
                        <option value="2702207">Coqueiro Seco</option>
                        <option value="2702306">Coruripe</option>
                        <option value="2702355">Craíbas</option>
                        <option value="2702405">Delmiro Gouveia</option>
                        <option value="2702504">Dois Riachos</option>
                        <option value="2702553">Estrela de Alagoas</option>
                        <option value="2702603">Feira Grande</option>
                        <option value="2702702">Feliz Deserto</option>
                        <option value="2702801">Flexeiras</option>
                        <option value="2702900">Girau do Ponciano</option>
                        <option value="2703007">Ibateguara</option>
                        <option value="2703106">Igaci</option>
                        <option value="2703205">Igreja Nova</option>
                        <option value="2703304">Inhapi</option>
                        <option value="2703403">Jacaré dos Homens</option>
                        <option value="2703502">Jacuípe</option>
                        <option value="2703601">Japaratinga</option>
                        <option value="2703700">Jaramataia</option>
                        <option value="2703759">Jequiá da Praia</option>
                        <option value="2703809">Joaquim Gomes</option>
                        <option value="2703908">Jundiá</option>
                        <option value="2704005">Junqueiro</option>
                        <option value="2704104">Lagoa da Canoa</option>
                        <option value="2704203">Limoeiro de Anadia</option>
                        <option value="2704302" selected>Maceió</option>
                        <option value="2704401">Major Isidoro</option>
                        <option value="2704500">Maragogi</option>
                        <option value="2704609">Maravilha</option>
                        <option value="2704708">Marechal Deodoro</option>
                        <option value="2704807">Maribondo</option>
                        <option value="2704906">Mar Vermelho</option>
                        <option value="2705002">Mata Grande</option>
                        <option value="2705101">Matriz de Camaragibe</option>
                        <option value="2705200">Messias</option>
                        <option value="2705309">Minador do Negrão</option>
                        <option value="2705408">Monteirópolis</option>
                        <option value="2705507">Murici</option>
                        <option value="2705606">Novo Lino</option>
                        <option value="2705705">Olho d'Água das Flores</option>
                        <option value="2705804">Olho d'Água do Casado</option>
                        <option value="2705903">Olho d'Água Grande</option>
                        <option value="2706000">Olivença</option>
                        <option value="2706109">Ouro Branco</option>
                        <option value="2706208">Palestina</option>
                        <option value="2706307">Palmeira dos Índios</option>
                        <option value="2706406">Pão de Açúcar</option>
                        <option value="2706422">Pariconha</option>
                        <option value="2706448">Paripueira</option>
                        <option value="2706505">Passo de Camaragibe</option>
                        <option value="2706604">Paulo Jacinto</option>
                        <option value="2706703">Penedo</option>
                        <option value="2706802">Piaçabuçu</option>
                        <option value="2706901">Pilar</option>
                        <option value="2707008">Pindoba</option>
                        <option value="2707107">Piranhas</option>
                        <option value="2707206">Poço das Trincheiras</option>
                        <option value="2707305">Porto Calvo</option>
                        <option value="2707404">Porto de Pedras</option>
                        <option value="2707503">Porto Real do Colégio</option>
                        <option value="2707602">Quebrangulo</option>
                        <option value="2707701">Rio Largo</option>
                        <option value="2707800">Roteiro</option>
                        <option value="2707909">Santa Luzia do Norte</option>
                        <option value="2708006">Santana do Ipanema</option>
                        <option value="2708105">Santana do Mundaú</option>
                        <option value="2708204">São Brás</option>
                        <option value="2708303">São José da Laje</option>
                        <option value="2708402">São José da Tapera</option>
                        <option value="2708501">São Luís do Quitunde</option>
                        <option value="2708600">São Miguel dos Campos</option>
                        <option value="2708709">São Miguel dos Milagres</option>
                        <option value="2708808">São Sebastião</option>
                        <option value="2708907">Satuba</option>
                        <option value="2708956">Senador Rui Palmeira</option>
                        <option value="2709004">Tanque d'Arca</option>
                        <option value="2709103">Taquarana</option>
                        <option value="2709152">Teotônio Vilela</option>
                        <option value="2709202">Traipu</option>
                        <option value="2709301">União dos Palmares</option>
                        <option value="2709400">Viçosa</option>
                    </select>
                </div>
                <button id="search-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 transform hover:scale-105">
                    Buscar Preços
                </button>
            </div>

            <!-- Loader (escondido por padrão) -->
            <div id="loader" class="hidden flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            </div>

            <!-- Div para resultados e estatísticas -->
            <div id="results" class="hidden mt-8 transition-all duration-300">
                <!-- Estatísticas em formato de tabela -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6 shadow-sm overflow-x-auto scrollbar-hide">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Resumo dos Preços</h2>
                    <table class="w-full text-center">
                        <thead>
                            <tr class="text-gray-600 uppercase text-xs leading-normal">
                                <th class="py-2">Média Interna</th>
                                <th class="py-2">Mediana</th>
                                <th class="py-2">Moda</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="font-bold text-lg">
                                <td id="trimmed-mean" class="py-2 text-blue-600">--</td>
                                <td id="median" class="py-2 text-green-600">--</td>
                                <td id="mode" class="py-2 text-purple-600">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tabela de Resultados -->
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-2 md:mb-0">Resultados da Pesquisa</h2>
                        <button id="download-button" class="w-full md:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                            Baixar Dados (CSV)
                        </button>
                    </div>
                    <input type="text" id="company-filter" placeholder="Filtrar por nome da empresa..."
                           class="w-full mb-4 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    <div class="overflow-x-auto scrollbar-hide">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <tr>
                                    <th class="py-3 px-6 text-left">Empresa</th>
                                    <th class="py-3 px-6 text-left">Preço (R$)</th>
                                    <th class="py-3 px-6 text-left">Data da Venda</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Resultados serão injetados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Div para mensagens de erro -->
            <div id="message-box" class="hidden mt-8 text-center text-gray-600 p-4 rounded-lg border border-gray-300">
                <p id="message-text">Nenhum resultado encontrado.</p>
            </div>
            
            <!-- Botão de link centralizado -->
            <div class="flex justify-center mt-8">
                <a href="https://economizaalagoas.sefaz.al.gov.br/economizaalagoas.htm" target="_blank"
                   class="bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-200 text-xs">
                    Clique aqui caso queria acessar a página oficial do governo do estado
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PROXY_API_ENDPOINT = "https://SUA_REGIAO-SEU_PROJETO_ID.cloudfunctions.net/proxyApi";
            const searchButton = document.getElementById('search-button');
            const downloadButton = document.getElementById('download-button');
            const productSearchInput = document.getElementById('product-search');
            const citySelect = document.getElementById('city-select');
            const resultsDiv = document.getElementById('results');
            const loaderDiv = document.getElementById('loader');
            const trimmedMeanElem = document.getElementById('trimmed-mean');
            const medianElem = document.getElementById('median');
            const modeElem = document.getElementById('mode');
            const resultsTableBody = document.getElementById('results-table-body');
            const companyFilterInput = document.getElementById('company-filter');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            let allResults = [];
            
            async function fetchData(payload) {
                try {
                    const response = await fetch(PROXY_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || "Erro na comunicação com o proxy.");
                    }

                    return await response.json();
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    return null;
                }
            }

            const calculateStatistics = (prices) => {
                if (prices.length === 0) {
                    return { trimmedMean: '--', median: '--', mode: '--' };
                }
                
                // Média Interna (trimmed mean)
                prices.sort((a, b) => a - b);
                const trimSize = Math.floor(prices.length * 0.05);
                const trimmedPrices = prices.slice(trimSize, prices.length - trimSize);
                const trimmedMean = trimmedPrices.reduce((sum, current) => sum + current, 0) / trimmedPrices.length;

                // Mediana
                const mid = Math.floor(prices.length / 2);
                const median = prices.length % 2 !== 0 ? prices[mid] : (prices[mid - 1] + prices[mid]) / 2;

                // Moda
                const counts = {};
                prices.forEach(price => {
                    counts[price] = (counts[price] || 0) + 1;
                });
                let modeValue = null;
                let maxCount = 0;
                for (const price in counts) {
                    if (counts[price] > maxCount) {
                        maxCount = counts[price];
                        modeValue = parseFloat(price);
                    } else if (counts[price] === maxCount) {
                        modeValue = null;
                    }
                }
                
                return { trimmedMean, median, mode: modeValue };
            };

            const renderResults = (data) => {
                resultsTableBody.innerHTML = '';
                if (!data || data.length === 0) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Nenhum resultado encontrado para este produto.';
                    resultsDiv.classList.add('hidden');
                    return;
                }

                messageBox.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
                
                const prices = data.map(item => item.produto.venda.valorVenda);
                const stats = calculateStatistics(prices);
                trimmedMeanElem.textContent = `R$ ${stats.trimmedMean.toFixed(2)}`;
                medianElem.textContent = `R$ ${stats.median.toFixed(2)}`;
                modeElem.textContent = stats.mode ? `R$ ${stats.mode.toFixed(2)}` : 'N/A';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                    const nomeFantasia = item.estabelecimento.nomeFantasia || 'Não informado';
                    const valorVenda = item.produto.venda.valorVenda.toFixed(2);
                    const dataVenda = new Date(item.produto.venda.dataVenda).toLocaleDateString('pt-BR');

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${nomeFantasia}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap font-bold text-green-600">R$ ${valorVenda}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${dataVenda}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
            };

            const searchPrices = async () => {
                const product = productSearchInput.value.trim();
                const cityIBGE = citySelect.value;
                if (!product) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Por favor, digite o nome de um produto para pesquisar.';
                    resultsDiv.classList.add('hidden');
                    return;
                }

                loaderDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                messageBox.classList.add('hidden');

                const payload = {
                    "produto": {"descricao": product},
                    "estabelecimento": {"municipio": {"codigoIBGE": cityIBGE}},
                    "dias": 5,
                    "pagina": 1,
                    "registrosPorPagina": 500
                };
                
                const data = await fetchData(payload);
                
                if (data && data.conteudo) {
                    allResults = data.conteudo;
                    renderResults(allResults);
                } else {
                    allResults = [];
                    messageBox.classList.remove('hidden');
                    messageText.textContent = `Não foi possível conectar à API. Verifique sua conexão ou tente novamente mais tarde.`;
                    resultsDiv.classList.add('hidden');
                }
                
                loaderDiv.classList.add('hidden');
            };
            
            const downloadCsv = () => {
                if (allResults.length === 0) {
                    messageBox.classList.remove('hidden');
                    messageText.textContent = 'Não há dados para baixar. Faça uma pesquisa primeiro.';
                    return;
                }

                const headers = ["descricao", "valorVenda", "dataVenda", "nomeFantasia", "razaoSocial", "cnpj", "municipio", "bairro"];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n";
                
                allResults.forEach(item => {
                    const produto = item.produto;
                    const estabelecimento = item.estabelecimento;
                    const venda = produto.venda;

                    const row = [
                        produto.descricao,
                        venda.valorVenda,
                        new Date(venda.dataVenda).toLocaleDateString('pt-BR'),
                        estabelecimento.nomeFantasia,
                        estabelecimento.razaoSocial,
                        estabelecimento.cnpj,
                        estabelecimento.endereco.municipio,
                        estabelecimento.endereco.bairro
                    ].map(value => `"${String(value).replace(/"/g, '""')}"`).join(";");

                    csvContent += row + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "analise_precos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            searchButton.addEventListener('click', searchPrices);
            downloadButton.addEventListener('click', downloadCsv);

            productSearchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    searchPrices();
                }
            });
            
            companyFilterInput.addEventListener('input', (e) => {
                const filterText = e.target.value.toLowerCase();
                const rows = resultsTableBody.getElementsByTagName('tr');
                Array.from(rows).forEach(row => {
                    const companyName = row.cells[0].textContent.toLowerCase();
                    if (companyName.includes(filterText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
